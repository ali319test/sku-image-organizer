import os
from flask import Flask, request, render_template, redirect, url_for, flash
from werkzeug.utils import secure_filename

app = Flask(__name__)
app.secret_key = "supersecretkey"  # Needed for flashing messages

BASE_DIR = "organized_images"
CHLOE_ROOT = "CHLOE SOURCING"
ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif'}

def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

@app.route("/", methods=["GET", "POST"])
def index():
    if request.method == "POST":
        sku = request.form.get("sku", "").strip().upper()
        folder = request.form.get("folder", "").strip()
        file = request.files.get("image")

        if not sku or not folder or not file:
            flash("Please provide SKU, folder name, and select an image.")
            return redirect(request.url)

        if not allowed_file(file.filename):
            flash("File type not allowed. Please upload an image file.")
            return redirect(request.url)

        filename = secure_filename(f"{sku}.jpg")
        save_folder = os.path.join(BASE_DIR, CHLOE_ROOT, folder)
        os.makedirs(save_folder, exist_ok=True)
        save_path = os.path.join(save_folder, filename)
        file.save(save_path)

        flash(f"Image saved as {filename} in {CHLOE_ROOT}/{folder}")
        return redirect(request.url)

    return render_template("index.html")
